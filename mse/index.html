<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1" />
<title>MediaSource API Demo</title>
</head>
<body>

<h3>Appending video chunks using the Media Source API</h3>

<section>
  <video controls autoplay width="320" height="240"></video>
  <pre id="log"></pre>
</section>

<script>
var FILE_PREFIX = 'file-chunk-';
var NUM_CHUNKS = 128;
var video = document.querySelector('video');
var mediaSource = new MediaSource();
video.src = window.URL.createObjectURL(mediaSource);

var chunkIndex = 0;

function onSourceOpen(e) {
  var sourceBuffer = mediaSource.addSourceBuffer('video/mp4; codecs="avc1.42E01E, mp4a.40.2"');

  logger.log('mediaSource readyState: ' + this.readyState);

  getNextFileChunk(FILE_PREFIX + chunkIndex, appendNextFileChunk);
}
  
function appendNextFileChunk(uInt8Array) {
  var file = new Blob([uInt8Array], {type: 'video/mp4'});
  var chunkSize = file.size;

  logger.log('downloaded chunk number: ' + chunkIndex);

  var reader = new FileReader();

  reader.onload = function(e) {
    sourceBuffer.appendBuffer(new Uint8Array(e.target.result));
    ++chunkIndex;
  };

  reader.readAsArrayBuffer(file);
};

sourceBuffer.addEventListener('updateend', function OnUpdateEnd() {
  logger.log('updateend: ' + chunkIndex);
  if (chunkIndex == NUM_CHUNKS - 1) {
    mediaSource.endOfStream();
  } else {
    ++chunkIndex;
    getNextFileChunk(FILE_PREFIX + chunkIndex, appendNextFileChunk);
  }
});

mediaSource.addEventListener('sourceopen', onSourceOpen, false);

mediaSource.addEventListener('sourceended', function(e) {
  logger.log('mediaSource readyState: ' + this.readyState);
}, false);

function getNextFileChunk(url, callback) {
  logger.log('Downloading chunk: ' + url);
  var xhr = new XMLHttpRequest();
  xhr.open('GET', url, true);
  xhr.responseType = 'arraybuffer';
  xhr.send();

  xhr.onload = function(e) {
    if (xhr.status != 200) {
      alert("Unexpected status code " + xhr.status + " for " + url);
      return false;
    }
    callback(new Uint8Array(xhr.response));
  };
}
</script>
<script>
function Logger(id) {
  this.el = document.getElementById('log');
}
Logger.prototype.log = function(msg) {
  var fragment = document.createDocumentFragment();
  fragment.appendChild(document.createTextNode(msg));
  fragment.appendChild(document.createElement('br'));
  this.el.appendChild(fragment);
};

Logger.prototype.clear = function() {
  this.el.textContent = '';
};

var logger = new Logger('log');
</script>
</body>
</html>
